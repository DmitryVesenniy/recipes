## HTTP/1.1

# Тюнинг ОС
  лимит файловых дескрипторов:
    nano /proc/sys/fs/file-max - количество файловых дескрипторов для ВСЕЙ системы
    nano /etc/sysctl.conf

    ## Настройки лимитов ограничения на количество одновременно открытых файлов в Linux

    Для вывода Soft -граничения выполните:
    ulimit –nS

    Для вывода Hard-ограничения:
    ulimit -Hn

    Чтобы разрешить всем сервисам открывать большее количество файлов, можно изменить лимиты на уровне всей ОС Linux. 
    Чтобы   новые настройки работали постоянно и не сбрасывались при перезапуске сервера или сессии, нужно поправить файл 
    etc/security/limits.conf. Добавьте строки:

    hard nofile 97816
    soft nofile 97816
  
    Ели вы используете Ubuntu, нужно прописать строку:
    session required pam_limits.so


    ## Увеличить лимита открытых файловых дескрипторов для отдельного сервиса

    Вы можете изменить лимит на количество открытых файловых дескрипторов для конкретного сервиса, а не для всей системы. 
    Чтобы изменить значения, откройте настройки службы через systemctl: 
    systemctl edit httpd.service 

    Добавьте необходимые лимиты, например:
    [Service]
    LimitNOFILE=16000
    LimitNOFILESoft=16000

    После изменения, нужно обновить конфигурацию сервиса и перезапустить его:
    systemctl daemon-reload
    systemctl restart httpd.service

    Чтобы проверить, изменились ли значения, нужно получить PID сервиса:
    systemctl status httpd.service


    ## Увеличение максимального количества открытых файлов для Nginx и Apache

    При изменении ограничения на количество открытых файлов для веб-сервера, 
    нужно также поправить конфигурационный файл службы. Например, для Nginx в файле конфигурации 
    /etc/nginx/nginx.conf, нужно прописать/изменить значение в директиве:
    worker_rlimit_nofile 16000

    После чего выполнить рестарт Nginx.

  Теоретический лимит на количество портов:
    cat /proc/sys/net/ipv4/ip_local_port_range
    выведет промежуток из которого будут предоставлены порты для сокет соединений

  Conntrack table - таблица ipTables, которая имеет ограничения по размеру
    sudo sysctl -a | grep conntrack_max
    Увеличить значение можно через файл /etc/sysctl.conf необходимо добавить или изменить записи:
      net.netfilter.nf_conntrack_max = 1048576

      Для применения изменений необходимо выполнить команду:
      sysctl -p

      Если установить большое значение при малом количестве оперативной памяти , то могут возникнуть проблемы с 
      переполнением памяти, в логах будет сообщение о нехватке оперативной памяти:
      kernel: Out of Memory

      Также можно изменить и другие параметры:
      net.netfilter.nf_conntrack_tcp_timeout_established = 86400
      который не даст держать открытым соединение без подтверждения более суток.

      Посмотреть сколько в данный момент записей в conntrack таблице можно командой:
      cat /proc/net/nf_conntrack | wc -l

      Можно установить пакет conntrack-tools и с его помощью собирать статистику:
      conntrack -L

      Данным скриптом можно проверять и вводить 15 ip-адресов у которых наибольшее количество соединений в данный момент.
      conntrack -L |awk '{if ($5 ~ /src/) print $5; else if ($4 ~ /src/) print $4}' | sed "s/src=/ /g" | sort | uniq -c | sort -n | tail -n15


      

